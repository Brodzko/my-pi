FROM node:22-slim

ARG PI_VERSION=0.52.12

RUN apt-get update && apt-get install -y --no-install-recommends \
  git \
  openssh-client \
  ripgrep \
  fd-find \
  file \
  curl \
  ca-certificates \
  tini \
  locales \
  && rm -rf /var/lib/apt/lists/* \
  && ln -s /usr/bin/fdfind /usr/local/bin/fd \
  && sed -i 's/^# *en_US.UTF-8/en_US.UTF-8/' /etc/locale.gen \
  && locale-gen

ENV LANG=en_US.UTF-8

RUN npm install -g @mariozechner/pi-coding-agent@${PI_VERSION} \
  && npm cache clean --force

# Rename node:22-slim's built-in `node` user (UID 1000) to `sandbox`.
RUN usermod -l sandbox -d /home/sandbox -m node \
  && groupmod -n sandbox node

# Bind-mounted project dirs may have a different owner UID.
RUN git config --system --add safe.directory '*'

USER sandbox
RUN mkdir -p /home/sandbox/.pi/agent

ENTRYPOINT ["/usr/bin/tini", "--"]
